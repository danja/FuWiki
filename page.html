<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>FuWiki</title>

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/common.css">

    <script src="js/marked.js"></script>

    <script src="js/jquery-1.10.2.js"></script>
    <script src="js/jquery-migrate-1.2.1.js"></script>
    
        <!-- date formatting -->
    <script src="js/moment.js"></script>

    <script src="js/config.js"></script>
    <script src="js/sparql-templates.js"></script>
    <script src="js/utils.js"></script>

    <script type="text/javascript" language="javascript">
        $(function () {

            var $loading = $('#spinner').hide();
            jQuery.ajaxSetup({
                beforeSend: function () {
                    $('#spinner').show();
                },
                complete: function () {
                    $('#spinner').hide();
                },
                success: function () {}
            });

            getPage();
            // $('#editButton').attr('href',window.location.href.replace("page.html", "edit.html"));
            $('#editButton').click(function () {
                window.location.href = window.location.href.replace("page.html", "edit.html");
                return false;
            });
        });

        function getPage() {
            var pageURI = queryString["uri"];
            //	  var getPageSparql = getPageSPARQL; // from sparql-queries.js (weird scoping thing)
            pageURI = encodeURI(pageURI);
            var getPageSparql = replaceAll(getPageSparqlTemplate, "${pageURI}", pageURI);
            getPageSparql = replaceAll(getPageSparql, "${graphURI}", graphURI);
            var getPageUrl = sparqlQueryEndpoint + encodeURIComponent(getPageSparql) + "&output=xml";
            //	$.get(url, function(xml) {
            $.ajax({
                url: getPageUrl,
                accept: {
                    xml: 'application/xml;charset=UTF-8',
                    sparql: 'sparql-results+xml;charset=UTF-8'
                },
                headers: { // belt and braces
                    'Accept': 'sparql-results+xml;charset=UTF-8'
                    //   'Accept-Charset': 'UTF-8' unsafe
                }

            }).done(function (xml) {
                entry = xmlToEntry(pageURI, xml);
                $("#entry").replaceWith(entry);
                translateLocalLinks();
            });
        }

        function generateEntry(uri, date, title, content, nick) {
            console.log("uri = " + uri + ", date = " + date + " , title = " + title + ", content = " + content + ", nick = " + nick);
            var entry = "<div class='entry'>";
            entry += "<h1 class='center'><a href=\"" + uri + "\">" + title + "</a></h1>";
            entry += "<div class='content'>" + marked(content) + "</div>";
            entry += "<div class='byline center'>latest edit by " + nick + " on " + moment(date).format("dddd, MMMM Do YYYY, h:mm:ss a")  + "</div>";
            entry += "</div>";
            return entry;
        }
    </script>

</head>

<body>
    <div id="container">

        <div colspan="8" class="center"><a href="index.html">FuWiki</a>
        </div>

        <div id="entry"></div>

        <p class="center">
            <button id="editButton">Edit</button>
        </p>

        <div id="spinner" class="spinner"></div>
    </div>
</body>

</html>
