<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>FooWiki</title>

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/common.css">
    <!-- link rel="stylesheet" type="text/css" href="css/jquery-ui.css" -->
    <!-- from https://github.com/aehlke/tag-it -->
    <link href="css/jquery.tagit.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="css/tagit.ui-zendesk.css">

    <script src="js/marked.js"></script>

    <script src="js/jquery-1.10.2.js"></script>
    <script src="js/jquery-migrate-1.2.1.js"></script>
    <script src="js/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>

    <!-- from https://github.com/aehlke/tag-it -->
    <script src="js/tag-it.js" type="text/javascript" charset="utf-8"></script>

    <!-- date formatting -->
    <script src="js/moment.js"></script>

    <script src="js/config.js"></script>
    <script src="js/sparql-templates.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/core.js"></script>

    <script type="text/javascript" language="javascript">
        $(function () {

            setupErrorHandling();
            spinner();

            var pageURI = queryString["uri"];
            pageURI = encodeURI(pageURI);

            var map = {
                "pageURI": pageURI,
                "graphURI": graphURI
            };

            var getPageSparql = templater(getPageSparqlTemplate, map);

            var getPageUrl = sparqlQueryEndpoint + encodeURIComponent(getPageSparql) + "&output=xml";

            var doneCallback = function (xml) {
                var entry = xmlToEntry(xml, pageURI);
                //  console.log("PJ=" + JSON.stringify(entry));
                if (!entry) {
                    entry = {
                        content: "",
                        date: "",
                        title: "",
                        nick: ""
                    };
                    window.location.href = window.location.href.replace("page.html", "edit.html");
                }

                
                // check if it's 
                if (preformatFormats.contains(entry.format)) { 
                    entry.content = "<pre>" + entry.content + "</pre>";
                }
                
                console.log("entry.format = "+entry.format);
                  console.log("runnableFormats = "+JSON.stringify(runnableFormats));
                  console.log("runnableFormats.contains(entry.format) = "+runnableFormats.contains(entry.format));
                   // check if it's runnable
                if (runnableFormats.contains(entry.format)) { 

                    var runButton = $("<button>");
                    $("#buttons").append(runButton);
                    runButton.attr("id", "runButton");
                    runButton.text("Run");
                    $("#runButton").click(function () {
                        window.location.href = window.location.href.replace("page.html", "run.html");
                        return false;
                    });
                };

                var entryHTML = formatEntry(entry);

                $("#entry").replaceWith(entryHTML);
                translateLocalLinks();
                fixHeaderIDs(); // little workaround for odd marked.js behaviour
                setupTags();
            };

            getPage(doneCallback, getPageUrl);

            $('#editButton').click(function () {
                window.location.href = window.location.href.replace("page.html", "edit.html");
                return false;
            });


        });

        function setupTags() {
            $("#tags").tagit({
                availableTags: ["c++", "java", "php", "javascript", "ruby", "python", "c"],
                readOnly: true
            });
        }

        function formatEntry(entry) {
            //   console.log("J=" + JSON.stringify(entry));

            entry.content = marked(entry.content);
            entry.date = moment(entry.date).format("dddd, MMMM Do YYYY, h:mm:ss a");

            var entryTemplate = "<div class='entry'> \
            <h1 class='center' id='pagetitle'><a href=${uri}>${title}</a></h1> \
            <div class='content'>${content}</div> \
            <div class='byline center'>latest edit by ${nick} on ${date}</div> \
      <label for='tags'>Tags</label> \
            <ul id='tags'> \
                <li>Tag1</li> \
                <li>Tag2</li> \
            </ul> \
            </div>";
            return templater(entryTemplate, entry);
        }
    </script>

</head>

<body>
    <div id="container">
        <div id="errorbox"></div>
        <div class="tab"><a href="index.html">Page Index</a>
        </div>

        <div id="entry"></div>

        <p id="buttons" class="center">
            <button id="editButton">Edit</button>
        </p>
        <div id="spinner" class="spinner"></div>
    </div>
</body>

</html>
