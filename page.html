<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>FooWiki</title>

    <link rel="stylesheet" href="css/columns.css" />
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/common.css">
    <!-- link rel="stylesheet" type="text/css" href="css/jquery-ui.css" -->
    <!-- from https://github.com/aehlke/tag-it -->
    <link href="css/jquery.tagit.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="css/tagit.ui-zendesk.css">
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css" />

    <script src="js/marked.js"></script>

    <!-- mustache template compiler -->
    <script src="js/hogan-3.0.2.js"></script>

    <script src="js/jquery-1.10.2.js"></script>
    <script src="js/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>

    <!-- from https://github.com/aehlke/tag-it -->
    <script src="js/tag-it.js" type="text/javascript" charset="utf-8"></script>

    <!-- date formatting -->
    <script src="js/moment.js"></script>

    <!-- FooWiki scripts -->
    <script src="js/config.js"></script>
    <script src="js/sparql-templates.js"></script>
    <script src="js/html-templates.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/core.js"></script>

    <script type="text/javascript" language="javascript">
        $(function () {

            setupErrorHandling();
            spinner();
            getPage();

            $('#editButton').click(function () {
                window.location.href = window.location.href.replace("page.html", "edit.html");
                return false;
            });
        });

        function getImage(imageURI, callback) {
            var pageMap = {
                "imageURI": imageURI,
                "graphURI": graphURI
            };

            var getPageSparql = templater(getImageSparqlTemplate, pageMap);

            var getPageUrl = sparqlQueryEndpoint + encodeURIComponent(getPageSparql) + "&output=xml";

            var doneCallback = function (xml) {

                var entryXmlNames = ["base64"];
                var entryJSON = sparqlXMLtoJSON(xml, entryXmlNames);
                var src ="data:image/jpeg;base64," + entryJSON[0]["base64"];
                
                callback(src);
            }
            getDataForURL(doneCallback, getPageUrl);
        }

        function getPage() {
            var pageURI = queryString["uri"];

             console.log("queryString = "+JSON.stringify(queryString));
            if (queryString["type"] == "image") {
            //    console.log("GET IMAGE");
                var callback = function(src){
                    window.location.href = src;
                };
                return getImage(pageURI, callback);
            }
            pageURI = encodeURI(pageURI);

            // console.log("pageURI ="+pageURI );

            var pageMap = {
                "pageURI": pageURI,
                "graphURI": graphURI
            };

            var getPageSparql = templater(getPageSparqlTemplate, pageMap);

            var getPageUrl = sparqlQueryEndpoint + encodeURIComponent(getPageSparql) + "&output=xml";

            var doneCallback = function (xml) {

                var entryJSON = sparqlXMLtoJSON(xml, entryXmlNames);

                if (!entryJSON) {
                    entryJSON = {
                        content: "",
                        date: "",
                        title: "",
                        nick: ""
                    };
                    window.location.href = window.location.href.replace("page.html", "edit.html");
                }

                // "uri": "page.html?uri=" + pageURI
                //      console.log("entryJSON[0] = " + JSON.stringify(entryJSON[0]));
                var entry = entryJSON[0];
                entry["uri"] = "page.html?uri=" + pageURI;
                // check if it's code-like
                if (preformatFormats.contains(entry.format)) {
                    entry.content = "<pre>" + entry.content + "</pre>";
                }
                //  console.log(entry.content);
                //   console.log("entry.format=" + entry.format);
                //   console.log(entry.content);
                // check if it's runnable
                if (runnableFormats.contains(entry.format)) {

                    var runButton = $("<button>");
                    $("#buttons").append(runButton);
                    runButton.attr("id", "runButton");
                    runButton.text("Run");
                    $("#runButton").click(function () {
                        window.location.href = window.location.href.replace("page.html", "run.html");
                        return false;
                    });
                };

                var entryHTML = formatEntry(entry);

                $("#entry").replaceWith(entryHTML);
                translateLocalLinks();
                fixHeaderIDs(); // little workaround for odd marked.js behaviour
                fixImageLinks(pageMap);
                setupTags("#maintagscontainer", pageMap, true);
                setupSearch("#searchContainer");
            };

            getDataForURL(doneCallback, getPageUrl);
        }

        function formatEntry(entry) {
            //  console.log("raw entry.content = " + entry.content);
            entry.content = tweakBlockquotes(entry.content);
            entry.content = marked(entry.content);

            // console.log("entry.content = " + entry.content);
            entry.date = moment(entry.date).format("dddd, MMMM Do YYYY, h:mm:ss a");
            return templater(pageEntryTemplate, entry);
        }

        function fixImageLinks(pageMap) {

            $("img").each(function () {
              //  var split = window.location.href.split("/");
            //    var path = split.slice(0, split.length - 1).join("/");
        //     path = path + "/" + $(this).attr("src") + "&type=image";
                // $(this).attr("src", path);
                var path = pagesBaseURI + $(this).attr("src");
                var me = this;
                var callback = function(src) {
                 //   console.log("SRC="+src);
                    $(me).attr("src", src);
                }
                getImage(path, callback);
            });
        }
    </script>

</head>

<body>
    <!-- div id="container" -->
    <div id="errorbox"></div>

    <div id="middle" class="column">
        <div id="entry"></div>

        <p id="buttons" class="center">
            <button id="editButton">Edit</button>
        </p>
    </div>

    <div id="left" class="column">
        <div class="tab"><a href="index.html">Page Index</a>
        </div>
    </div>

    <div id="right" class="column">
        <div id='searchContainer'>
            <button id='searchButton'>Search</button>
            <!-- label for='searchText'>Search Text</label -->
            <input id='searchText' type='text' value=''></input>
            <div id='tagButtons'></div>
            <ul id="results"></ul>
        </div>
    </div>

    <div id="spinner" class="spinner"></div>
    <!-- /div -->
<div id="testImage" />
</body>

</html>
